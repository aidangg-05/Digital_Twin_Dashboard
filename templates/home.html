<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Kanit&display=swap"
      rel="stylesheet"
    />
    <title>Document</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='home.css') }}"
    />
    <style type="text/css">
      .graph-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: flex-start;
      }
      .graph {
        width: calc(50% - 10px); /* Adjust width to 50% minus margin */
        margin-bottom: 20px; /* Add some margin between rows */
      }
      .graph canvas {
        width: 75%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <section>
      <div class="nav-container">
        <div class="theme-toggle">
          <img
            id="SP"
            src="{{ url_for('static', filename='img/download.png') }}"
          />
        </div>
        <div id="Title">CNC Dashboard</div>
        <ul class="links">
          <li><a href="#Motor_x">Motor X</a></li>
          <li>•</li>
          <li><a href="#Motor_y">Motor Y</a></li>
          <li>•</li>
          <li><a href="#Motor_z">Motor Z</a></li>
          <li>•</li>
          <li><a href="#spindle">Spindle</a></li>
          <li>•</li>
          <li><a href="#" onclick="openSettings()">Settings</a></li>
        </ul>
      </div>
    <div class="overlay">
      <div id="notificationBox">
          <p id="emergency-text">Emergency Stop Activated!</p>
      </div>
    </div>
    <div id="settingsModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeSettings()">&times;</span>
        <h2>Settings</h2>
        <label for="darkModeCheckbox">Dark Mode:</label>
        <input
          type="checkbox"
          id="darkModeCheckbox"
          onchange="toggleDarkMode()"
        />
        <br />
        <button class="download-button" onclick="downloadMongoDBDataCSV()">
          Download Data
        </button>
      </div>
    </div>

    <h1 id="Motor_x" class="heading">Motor X</h1>
    <section class="graph-container monkey">
      <div class="graph">
        <h1 class="heading">Current</h1>
        <div class="canvas-holder">
          <canvas id="myGraph1"></canvas>
        </div>
      </div>
      <div class="graph">
        <h1 class="heading">MaxCurrent</h1>
        <div class="canvas-holder">
          <canvas id="myGraph2"></canvas>
        </div>
      </div>
      <div class="graph">
        <h1 class="heading">Cycle Count</h1>
        <div class="canvas-holder">
          <canvas id="myGraph3"></canvas>
        </div>
      </div>
      <div class="graph">
        <h1 class="heading">ScaPos1</h1>
        <div class="canvas-holder">
          <canvas id="myGraph4"></canvas>
        </div>
      </div>
    </section>

    <h1 id="Motor_y" class="heading">Motor Y</h1>
    <section class="graph-container">
      <div class="graph">
        <h1 class="heading">Current</h1>
        <div class="canvas-holder">
          <canvas id="myGraph5"></canvas>
        </div>
      </div>
      <div class="graph">
        <h1 class="heading">MaxCurrent</h1>
        <div class="canvas-holder">
          <canvas id="myGraph6"></canvas>
        </div>
      </div>
      <div class="graph">
        <h1 class="heading">Cycle Count</h1>
        <div class="canvas-holder">
          <canvas id="myGraph7"></canvas>
        </div>
      </div>
      <div class="graph">
        <h1 class="heading">ScaPos2</h1>
        <div class="canvas-holder">
          <canvas id="myGraph8"></canvas>
        </div>
      </div>
    </section>

    <h1 id="Motor_z" class="heading">Motor Z</h1>
    <section class="graph-container">
      <div class="graph">
        <h1 class="heading">Current</h1>
        <div class="canvas-holder">
          <canvas id="myGraph9"></canvas>
        </div>
      </div>
      <div class="graph">
        <h1 class="heading">MaxCurrent</h1>
        <div class="canvas-holder">
          <canvas id="myGraph10"></canvas>
        </div>
      </div>
      <div class="graph">
        <h1 class="heading">Cycle Count</h1>
        <div class="canvas-holder">
          <canvas id="myGraph11"></canvas>
        </div>
      </div>
      <div class="graph">
        <h1 class="heading">ScaPos3</h1>
        <div class="canvas-holder">
          <canvas id="myGraph12"></canvas>
        </div>
      </div>
    </section>

    <h1 id="spindle" class="heading">Spindle</h1>
    <section class="graph-container">
      <div class="graph">
        <h1 class="heading">Cycle Count</h1>
        <div class="canvas-holder">
          <canvas id="myGraph13"></canvas>
        </div>
      </div>
      <div class="graph">
        <h1 class="heading">Droop</h1>
        <div class="canvas-holder">
          <canvas id="myGraph14"></canvas>
        </div>
      </div>
      <div class="graph">
        <h1 class="heading">Gain</h1>
        <div class="canvas-holder">
          <canvas id="myGraph15"></canvas>
        </div>
      </div>
      <div class="graph">
        <h1 class="heading">Load</h1>
        <div class="canvas-holder">
          <canvas id="myGraph16"></canvas>
        </div>
      </div>
    </section>
    <script>
      // Function to open the settings modal
      function openSettings() {
        var modal = document.getElementById("settingsModal");
        modal.style.display = "block";
      }

      // Function to close the settings modal
      function closeSettings() {
        var modal = document.getElementById("settingsModal");
        modal.style.display = "none";
      }

      // Close the modal if the user clicks outside of it
      window.onclick = function (event) {
        var modal = document.getElementById("settingsModal");
        if (event.target == modal) {
          modal.style.display = "none";
        }
      };

      function toggleDarkMode() {
        var darkModeCheckbox = document.getElementById("darkModeCheckbox");
        var body = document.body;
        var spImage = document.getElementById("SP");

        if (darkModeCheckbox.checked) {
          body.classList.add("dark-mode");
          spImage.src = "{{ url_for('static', filename='img/sp_logo.png') }}"; // Update source for dark mode
        } else {
          body.classList.remove("dark-mode");
          spImage.src = "{{ url_for('static', filename='img/download.png') }}"; // Update source for light mode
        }
      }
      function downloadMongoDBDataCSV() {
        window.location.href = "/download_database_csv";
      }

      var charts = [];
      var graphIds = [
        "myGraph1",
        "myGraph2",
        "myGraph3",
        "myGraph4",
        "myGraph5",
        "myGraph6",
        "myGraph7",
        "myGraph8",
        "myGraph9",
        "myGraph10",
        "myGraph11",
        "myGraph12",
        "myGraph13",
        "myGraph14",
        "myGraph15",
        "myGraph16",
      ];
      var maxDataPoints = 10; // Define the maximum number of data points to display

      // Define colors for each set of graphs
      var colors = [
        "rgba(255, 99, 132, 1)", // Red
        "rgba(54, 162, 235, 1)", // Dark Blue
        "rgba(75, 192, 192, 1)", // Dark Green
        "rgba(153, 102, 255, 1)", // Dark Purple
      ];

      graphIds.forEach(function (graphId, index) {
        var ctx = document.getElementById(graphId).getContext("2d");
        var colorIndex = Math.floor(index / 4); // Determine which set of colors to use
        var color = colors[colorIndex]; // Assign color based on the set

        var chart = new Chart(ctx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Value",
                data: [],
                backgroundColor: color,
                borderColor: color,
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              xAxes: [
                {
                  type: "time",
                  time: {
                    unit: "second",
                    parser: "HH:mm:ss", // Explicitly specify the datetime format
                    displayFormats: {
                      second: "h:mm:ss", // Customize datetime format here
                    },
                    tooltipFormat: "h:mm:ss", // Customize tooltip format
                  },
                  ticks: {
                    maxTicksLimit: 50, // Adjust maximum number of ticks as needed
                  },
                },
              ],
              yAxes: [
                {
                  // Add options for the y-axis if needed
                },
              ],
            },
          },
        });

        charts.push(chart);
      });

      function fetchData() {
    // Define node keys to fetch data for
    var nodeKeys = [
        1, 40, 3, 13, 2, 41, 4, 14, 6, 42, 5, 15, 45, 23, 22, 44,
    ]; // Example node keys

    // Fetch data for each node key
    nodeKeys.forEach(function (key, index) {
        fetch("/data?NodeKey=" + key)
            .then((response) => response.json())
            .then((data) => {
                if (data[key]) {
                    charts[index].data.labels.push(data[key].ServerTimeStamp);
                    charts[index].data.datasets[0].data.push(data[key].Value);

                    if (charts[index].data.labels.length > maxDataPoints) {
                        charts[index].data.labels.shift();
                        charts[index].data.datasets[0].data.shift();
                    }

                    charts[index].update();
                }
            })
            .catch(error => console.error("Error fetching data:", error)); // Handle errors
    });
}

function EmergencyStop() {
    fetch("/data?NodeKey=74")
        .then((response) => response.json())
        .then((data) => {
            if (data[74] && data[74].Value === 128) {
                showBox();
            } else if (data[74] && data[74].Value === 0) {
                hideBox();
            }
            if (data[74]) {
                console.log("Value of NodeKey 74:", data[74].Value);
            }
        })
        .catch(error => console.error("Error fetching data for NodeKey 74:", error)); // Handle errors
}

function showBox() {
    var box = document.getElementById("notificationBox");
    var overlay = document.querySelector(".overlay");
    box.style.display = "block";
    overlay.classList.add("active"); // Add the active class to the overlay
}

function hideBox() {
    var box = document.getElementById("notificationBox");
    var overlay = document.querySelector(".overlay");
    box.style.display = "none";
    overlay.classList.remove("active"); // Remove the active class from the overlay
}

// Fetch data initially
fetchData();
EmergencyStop();

// Fetch data every 3 seconds
setInterval(fetchData, 3000);
setInterval(EmergencyStop, 3000);

    </script>

    <script src="index.js"></script>
  </body>
</html>
